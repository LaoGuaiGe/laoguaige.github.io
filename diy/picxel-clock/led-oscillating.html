<!DOCTYPE html>

<html lang="en"  class="">


<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="keywords" content="keyword1, keyword2">
    
    
    <meta name="description" content="description for this article">
    
    <meta name="generator" content="teedoc">
    <meta name="theme" content="teedoc-plugin-theme-default">
    
        
        <meta name="markdown-generator" content="teedoc-plugin-markdown-parser">
        
        <script>
MathJax = {"loader": {"load": ["output/svg"]}, "tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]]}, "svg": {"fontCache": "global"}};
</script>
        
        <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
        
        <meta name="html-generator" content="teedoc-plugin-jupyter-notebook-parser">
        
        <script src="/static/js/theme_default/pre_main.js"></script>
        
        <link rel="stylesheet" href="/static/css/theme_default/prism.min.css" type="text/css"/>
        
        <link rel="stylesheet" href="/static/css/theme_default/viewer.min.css" type="text/css"/>
        
        <link rel="stylesheet" href="/static/css/theme_default/dark.css" type="text/css"/>
        
        <link rel="stylesheet" href="/static/css/theme_default/light.css" type="text/css"/>
        
        <script src="/static/js/theme_default/jquery.min.js"></script>
        
        <script src="/static/js/theme_default/split.js"></script>
        
        <link rel="stylesheet" href="/static/css/gitalk/gitalk.css" type="text/css"/>
        
        <link rel="stylesheet" href="/static/css/gitalk/custom_gitalk.css" type="text/css"/>
        
        <link rel="stylesheet" href="/static/css/custom.css" type="text/css"/>
        
        <link rel="stylesheet" href="/static/css/search/style.css" type="text/css"/>
        
    
    
    <title>FFT音律灯 - Hdochub</title>
    
    <script type="text/javascript">js_vars = {"teedoc-plugin-ad-hint": {"type": "hint", "label": "☆", "content": "这里是老怪鸽的个人技术文档记录中心</br>喜欢项目请<a target=\"_blank\" href=\"https://github.com/LaoGuaiGe/laoguaige.github.io\">点下 ☆ star </a>哦~🦀🦀", "show_times": 2, "show_after_s": 432000, "date": "2021-11-16 14:40", "color": "#a0421d", "link_color": "#e53935", "link_bg_color": "#e6ae5c", "bg_color": "#ffcf89", "color_hover": "white", "bg_color_hover": "#f57c00", "close_color": "#eab971"}}</script>
    <script type="text/javascript">metadata = {"tags": [], "date": "2024-12-05", "update": [{"date": "2024-12-05", "author": "老怪鸽", "version": "1.0.1", "content": "更新了基本文档"}], "ts": 1733356800, "author": "", "brief": "", "cover": "", "show_source": false}</script>
</head>


<body class="type_doc">
    
    <div id="navbar">
        <div id="navbar_menu">
            <a class="site_title" href="/">
                
                    <img class="site_logo" src="/static/images/logo.png" alt="HDocHub logo">
                
                
                    <h2>HDocHub</h2>
                
        </a>
            <a id="navbar_menu_btn"></a>
        </div>
        <div id="navbar_items">
            <div>
                <ul id="nav_left">
<li class=""><a  href="/">首页</a></li>
<li class=""><a  href="/c-basics/">C语言</a></li>
<li class=""><a  href="/python/">Python</a></li>
<li class=""><a  href="/linux/">Linux</a></li>
<li class=""><a  href="/markdown/">MarkDown</a></li>
<li class=""><a  href="/git/">Git</a></li>
<li class=""><a  href="/mcu/">单片机</a></li>
<li class=""><a  href="/module/">电子模块驱动合集</a></li>
<li class="active"><a  href="/diy/">DIY项目</a></li>
</ul>

            </div>
            <div>
                <ul id="nav_right">
<li class=""><a target="_blank" href="https://github.com/LaoGuaiGe/laoguaige.github.io">github</a></li>
</ul>

                <ul class="nav_plugins"><li><a id="themes" class="light"></a></li></ul><ul class="nav_plugins"><li><a id="search"><span class="icon"></span><span class="placeholder">搜索</span>
                            <div id="search_hints">
                                <span id="search_input_hint">输入关键词，多关键词空格隔开</span>
                                <span id="search_loading_hint">正在加载，请稍候。。。</span>
                                <span id="search_download_err_hint">下载文件失败，请刷新重试或检查网络</span>
                                <span id="search_other_docs_result_hint">来自其它文档的结果</span>
                                <span id="search_curr_doc_result_hint">当前文档搜索结果</span>
                            </div></a></li></ul>
            </div>
        </div>
    </div>
    
    <div id="wrapper">
        <div id="sidebar_wrapper">
            <div id="sidebar">
                <div id="sidebar_title">
                    
                </div>
                <ul class="show">
<li class="not_active with_link"><a href="/diy/index.html"><span class="label">项目集合</span><span class=""></span></a></li>
<li class="active_parent with_link"><a href="/diy/picxel-clock/basic.html"><span class="label">物联网像素时钟⏰</span><span class="sub_indicator"></span></a><ul class="show">
<li class="not_active with_link"><a href="/diy/picxel-clock/basic.html"><span class="label">✨项目信息</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/diy/picxel-clock/download.html"><span class="label">⬇️资料下载</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/diy/picxel-clock/hardware.html"><span class="label">0. 硬件设计</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/diy/picxel-clock/install.html"><span class="label">1. 软件环境搭建</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/diy/picxel-clock/ds1302.html"><span class="label">2. RTC时钟驱动</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/diy/picxel-clock/dht11.html"><span class="label">3. 温湿度采集</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/diy/picxel-clock/ledmatrix.html"><span class="label">4. 彩灯驱动</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/diy/picxel-clock/ntptime.html"><span class="label">5. 获取网络时间</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/diy/picxel-clock/weather.html"><span class="label">6. 获取天气情况</span><span class=""></span></a></li>
<li class="active with_link"><a href="/diy/picxel-clock/led-oscillating.html"><span class="label">7. 实现FFT音律灯</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/diy/picxel-clock/voice.html"><span class="label">8. 语音识别与播报</span><span class=""></span></a></li>
</ul>
</li>
<li class="not_active with_link"><a href="/diy/wiki-web/basic.html"><span class="label">WIKI网站搭建🌐</span><span class=""></span></a></li>
</ul>

            </div>
        </div>
        <div id="article">
            <div id="menu_wrapper">
                <div id="menu">
                </div>
            </div>
            <div id="content_wrapper">
                <div id="content_body">
                    <div id="article_head">
                        <div id="article_title">
                            
                            <h1>FFT音律灯</h1>
                            
                        </div>
                        <div id="article_tags">
                            <ul>
                            
                            </ul>
                        </div>
                        <div id="article_info">
                        <div id="article_info_left">
                            <span class="article_author">
                                
                            </span>
                            
                                <span class="article_date" title="Last modify date: 2024-12-05">
                                    2024-12-05
                                </span>
                            
                        </div>
                        <div id="article_info_right">
                            
                        </div>
                        </div>
                    </div>
                    <div id="article_tools">
                        <span></span>
                        <span id="toc_btn"></span>
                    </div>
                    <div id="update_history">
                        
                        
                        <details open>
                        
                            <summary>Update history</summary>
                            <div>
                                <table>
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Version</th>
                                                <th>Author</th>
                                                <th>Update content</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            
                                                <tr>
                                                    <td>2024-12-05</td>
                                                    <td>1.0.1</td>
                                                    <td>老怪鸽</td>
                                                    <td>
                                                    
                                                        更新了基本文档
                                                    
                                                    </td>
                                                </tr>
                                            
                                        </tbody>
                                </table>
                            </div>
                        </details>
                        
                    </div>
                    <div id="article_content">
                        
                            <hr />
<blockquote class="spoiler warning">
<p> 本文继承自之前的👉<a href="ledmatrix.html"  >彩灯驱动</a>章节</p>
</blockquote>
<hr />
<p><strong>本文完成的效果：</strong></p>
<p><img src="../../static/images/docs/diy/picxel-clock/led-oscillating/led-oscillating-2024-12-06-00-05-00.gif" alt="图 0" /></p>
<h2 id="%E7%A1%AC%E4%BB%B6%E5%87%86%E5%A4%87">硬件准备</h2>
<hr />
<h3 id="WS2812%E7%9F%A9%E9%98%B5%E5%BD%A9%E7%81%AF">WS2812矩阵彩灯</h3>
<p><img src="../../static/images/docs/diy/picxel-clock/ledmatrix/ledmatrix-2024-12-05-23-14-08.png" alt="图 0" /></p>
<p><strong>购买地址：</strong><a href="https://item.taobao.com/item.htm?spm=a1z09.2.0.0.24ee2e8dC5LwBl&amp;id=737696448369&amp;_u=r2t4uge57a73&amp;skuId=5263566850408"  target="_blank">WS2812B全彩软像素屏8X8 8X32 16X16幻彩5V显示可编程像素软屏</a></p>
<h3 id="%E9%BA%A6%E5%85%8B%E9%A3%8E%E6%A8%A1%E5%9D%97">麦克风模块</h3>
<p><img src="../../static/images/docs/diy/picxel-clock/led-oscillating/led-oscillating-2024-12-06-00-05-36.png" alt="图 1" /></p>
<p>购买地址：<a href="https://item.taobao.com/item.htm?spm=a21n57.1.item.2.2af5523csIlNsa&amp;priceTId=2147bfce17220928379633421e49bd&amp;utparam=%7B%22aplus_abtest%22:%22c7a787e4caab2b1c51f9ce5bba439f54%22%7D&amp;id=619436010637&amp;ns=1&amp;abbucket=4"  target="_blank">GY-MAX4466 声音传感器模块 MAX4466麦克风前置放大器 提供程序</a></p>
<h3 id="ESP32S3%E5%BC%80%E5%8F%91%E6%9D%BF">ESP32S3开发板</h3>
<p><img src="../../static/images/docs/diy/picxel-clock/ledmatrix/ledmatrix-2024-12-05-23-14-24.png" alt="图 1" /></p>
<p><strong>购买地址：</strong><a href="https://item.szlcsc.com/22034693.html?fromZone=s_s__%2522%25E7%25AB%258B%25E5%2588%259B%25E5%25BC%2580%25E5%258F%2591%25E6%259D%25BF%2522"  target="_blank">立创·ESP32S3R8N8 开发板</a></p>
<h2 id="%E5%B7%A5%E7%A8%8B%E5%88%9B%E5%BB%BA">工程创建</h2>
<hr />
<p>在VSCode中打开PlatformIO扩展创建名为<code>OscillatingLED</code>的 <code>Espressif ESP32-S3-DevKitM-1</code> 工程。</p>
<p>关于详细图文创建工程的过程请参考👉<a href="ds1302.html"  >RTC时钟驱动</a>章节的工程创建小节。</p>
<h2 id="%E5%AE%89%E8%A3%85%E9%A9%B1%E5%8A%A8%E5%BA%93">安装驱动库</h2>
<hr />
<p>创建完成之后，打开驱动库下载界面。实现功能的最底层的驱动，需要分别安装三个库：</p>
<ol>
<li><p>搜索<code>Adafruit NeoMatrix</code>，安装来自<code>Adafruit</code>的<code>Adafruit NeoMatrix</code>库。</p>
</li>
<li><p>搜索<code>Adafruit GFX Library</code>，安装来自<code>Adafruit</code>的<code>Adafruit GFX Library</code>库。</p>
</li>
<li><p>搜索<code>arduinoFFT</code>，安装来自<code>Enrique Condes</code>的<code>arduinoFFT</code>库。</p>
</li>
</ol>
<p>将它们都安装到我们的工程当中。</p>
<blockquote>
<p>关于详细图文安装驱动库的过程请参考👉<a href="ds1302.html"  >RTC时钟驱动</a>章节的安装驱动库小节。</p>
</blockquote>
<p>都安装完成之后，打开<code>platformio.ini</code>文件，应该可以看到已经安装上了三个驱动库。</p>
<p><img src="../../static/images/docs/diy/picxel-clock/led-oscillating/led-oscillating-2024-12-06-00-07-06.png" alt="图 2" /></p>
<h2 id="%E7%BC%96%E8%BE%91%E4%BB%A3%E7%A0%81">编辑代码</h2>
<hr />
<p>在工程下的<code>include</code>文件夹下新建一个 <code>musicfft.h</code>文件。</p>
<p>接下来往 <code>musicfft.h</code> 文件写入代码：</p>

<pre class="language-c"><code class="language-c">#include &lt;Adafruit_NeoMatrix.h&gt;
#include &lt;arduinoFFT.h&gt;

#define CHANNEL 1  //音频输入引脚
#define xres 32   
#define yres 8            


const uint16_t samples = 64; //采样点数，必须为2的整数次幂
const double samplingFrequency = 4000; //Hz, 声音采样频率

unsigned int sampling_period_us;
unsigned long microseconds;
unsigned long lastTime = 0;
unsigned long fallingTime = 0;

double vReal[samples]; //FFT采样输入样本数组
double vImag[samples]; //FFT运算输出数组
int freq_gain2[xres] = {30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30};
int Intensity[xres] = {}; // initialize Frequency Intensity to zero
int FallingPoint[xres] = {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0};
int Displacement = 1;          // Create LED Object

//ArduinoFFT FFT = ArduinoFFT(); //创建FFT对象
ArduinoFFT&lt;double&gt; FFT = ArduinoFFT&lt;double&gt;(vReal, vImag, samples, samplingFrequency);


void getSamples(){
  microseconds = micros();
  for(int i = 0; i &lt; samples; i++){
    vReal[i] = analogRead(CHANNEL);
    vImag[i] = 0;
    microseconds += sampling_period_us;
  }
  bool reduce = false;
  if ((millis() - lastTime) &gt; 16) {
    lastTime = millis();
    reduce = true;
  }
  //FFT
  FFT.windowing(vReal, 1, FFT_WIN_TYP_HAMMING, FFT_FORWARD);
  FFT.compute(vReal, vImag, samples, FFT_FORWARD);
  FFT.complexToMagnitude(vReal, vImag, samples);
  //Update Intensity Array  
  int t = 16;
  for(int i = t; i &lt; (xres*Displacement)+t; i+=Displacement){
    vReal[i] = constrain(vReal[i], 0 ,3596);            // set max value for input data
    vReal[i] = map(vReal[i], freq_gain2[(i-t)/Displacement], 1548, 0, yres);        // map data to fit our display
    if(reduce){
      Intensity[(i-t)/Displacement] --;                      // Decrease displayed value
    }
    if (vReal[i] &gt; Intensity[(i-t)/Displacement])          // Match displayed value to measured value
      Intensity[(i-t)/Displacement] = vReal[i];
  }
}

void drawYLine(Adafruit_NeoMatrix *matrix, int16_t x, int16_t y, int16_t h, int16_t c){
  for(int i=y;i&lt;y+h;i++){
    matrix-&gt;drawPixel(x,7 - i,c);
  }
}

uint16_t hsv2rgb2(Adafruit_NeoMatrix *matrix, uint16_t hue, uint8_t saturation, uint8_t value)
{
    uint8_t red = 0;
    uint8_t green = 0;
    uint8_t blue = 0;
    uint16_t hi = (hue / 60) % 6;
    uint16_t F = 100 * hue / 60 - 100 * hi;
    uint16_t P = value * (100 - saturation) / 100;
    uint16_t Q = value * (10000 - F * saturation) / 10000;
    uint16_t T = value * (10000 - saturation * (100 - F)) / 10000;

    switch (hi)
    {
    case 0:
        red = value;
        green = T;
        blue = P;
        break;
    case 1:
        red = Q;
        green = value;
        blue = P;
        break;
    case 2:
        red = P;
        green = value;
        blue = T;
        break;
    case 3:
        red = P;
        green = Q;
        blue = value;
        break;
    case 4:
        red = T;
        green = P;
        blue = value;
        break;
    case 5:
        red = value;
        green = P;
        blue = Q;
        break;
    default:
        return matrix-&gt;Color(255, 0, 0);
    }
    red = red * 255 / 100;
    green = green * 255 / 100;
    blue = blue * 255 / 100;
    return matrix-&gt;Color(red, green, blue);
}

void displayUpdate(Adafruit_NeoMatrix *matrix, int displayPattern){
  int color = 0;
  switch(displayPattern){
    case 0:
      for(int i = 0; i &lt; xres; i++){
        drawYLine(matrix,i,yres-Intensity[i],Intensity[i],hsv2rgb2(matrix, color, 80, 80 ));
        drawYLine(matrix,i,0,yres-1-Intensity[i],hsv2rgb2(matrix, color, 80, 80 ));
        color += 360/xres;
      }
      break;
    case 1:
      if ((millis() - fallingTime) &gt; 130) {
        for(int i = 0; i &lt; xres; i++){
          if(FallingPoint[i]&gt;0){
            FallingPoint[i]--;
          }
        }
        fallingTime = millis();
      }
      for(int i = 0; i &lt; xres; i++){
        drawYLine(matrix,i,0,yres-1,matrix-&gt;Color(0,0,0));
        if(FallingPoint[i]&lt;Intensity[i]){
          FallingPoint[i] = Intensity[i];
        }
        drawYLine(matrix,i,yres-Intensity[i]+1,Intensity[i]-1,hsv2rgb2(matrix, color, 80, 80 ));
        if(FallingPoint[i]&gt;0){
          matrix-&gt;drawPixel(i,yres-FallingPoint[i],matrix-&gt;Color(255,255,255));
        }
        color += 360/xres;
      }
      break;
    case 2:
      for(int i = 0; i &lt; xres; i++){
        drawYLine(matrix,i,0,yres,matrix-&gt;Color(0,0,0));
        drawYLine(matrix,i,0,Intensity[i]+1,hsv2rgb2(matrix, color, 80, 80 ));
        color += 360/xres;
      }
      break;
  }
}

</code></pre>
<p>接下来在 <code>main.cpp</code>中编写以下代码：</p>

<pre class="language-c"><code class="language-c">#include &lt;Arduino.h&gt;
#include &lt;Adafruit_NeoMatrix.h&gt; //点亮LED矩阵需要的库
#include &quot;musicfft.h&quot; //音乐频谱库

//像素阵列定义
#define kMatrixWidth   32             //宽度
#define kMatrixHeight  8              //高度
#define BRIGHTNESS     10            //默认亮度 0-255
#define BRIGHTNESS_INTERVAL 30        //亮度调节间隔
#define LED_PIN        8              //像素阵列引脚

Adafruit_NeoMatrix *matrix;     //LED矩阵类指针

//像素矩阵初始化
void InitLED_Matrix(void)
{
  //设置像素矩阵的方向以及排列方式
  matrix = new Adafruit_NeoMatrix(32, 8, LED_PIN, NEO_MATRIX_TOP + NEO_MATRIX_LEFT+
    NEO_MATRIX_COLUMNS +  NEO_MATRIX_ZIGZAG,
    NEO_GRB + NEO_KHZ800);
  matrix-&gt;setTextWrap(false);       //设置文字是否自动换行
  matrix-&gt;clear();                  //清除当前显示内容
  matrix-&gt;setBrightness(BRIGHTNESS);//设置亮度
}

void showFFT(void)
{
  //进行采样
  getSamples();
  //更新频谱柱
  displayUpdate(matrix, 2);
}

void setup() 
{
  //初始化LED矩阵显示
  InitLED_Matrix();    
}

void loop() 
{
  matrix-&gt;clear();
  showFFT();
  matrix-&gt;show();

  delay(50);
}
</code></pre>
<h2 id="%E7%A1%AC%E4%BB%B6%E8%BF%9E%E6%8E%A5">硬件连接</h2>
<hr />
<p><img src="../../static/images/docs/diy/picxel-clock/led-oscillating/led-oscillating-2024-12-06-00-08-04.png" alt="图 3" /></p>
<h1 id="6.-%E4%BB%A3%E7%A0%81%E9%AA%8C%E8%AF%81">6. 代码验证</h1>
<hr />
<p>代码编写完成之后，将ESP32S3开发板接入电脑下载代码。然后观察彩灯矩阵的现象。</p>
<p>实物显示如下：</p>
<p><strong>使用黑色亚克力面板+白纸格挡光线显示</strong></p>
<blockquote>
<p>叠层从上到下是这样的：黑色亚克力面板 -&gt; 白纸 -&gt; LED矩阵</p>
</blockquote>
<p><img src="../../static/images/docs/diy/picxel-clock/led-oscillating/led-oscillating-2024-12-06-00-05-00.gif" alt="图 0" /></p>
<blockquote class="spoiler warning">
<p> 说明：如果你根据代码操作运行不起来，可以下载👉<a href="https://gitee.com/laoguaige/esp32-s3-r8-n8-pixel-clock/tree/master/example/OscillatingLED"  target="_blank">例程</a>看看</p>
</blockquote>

                        
                    </div>
                </div>
                <div id="previous_next">
                    <div id="previous">
                        
                        <a href="/diy/picxel-clock/weather.html">
                            <span class="icon"></span>
                            <span class="label">6. 获取天气情况</span>
                        </a>
                        
                    </div>
                    <div id="next">
                        
                        <a href="/diy/picxel-clock/voice.html">
                            <span class="label">8. 语音识别与播报</span>
                            <span class="icon"></span>
                        </a>
                        
                    </div>
                </div>
                <div id="comments-container"></div>
            </div>
            <div id="toc_wrapper">
                <div id="toc">
                    <div id="toc_content">
                            
                    </div>
                </div>
            </div>
        </div>
    </div>
    <a id="to_top" href="#"></a>
    <div id="doc_footer">
        <div id="footer">
            <div id="footer_top">
                <ul>
<li><a>链接</a><ul><li><a target="_blank" href="https://github.com/teedoc/teedoc">本网站使用 teedoc 构建</a></li>
</ul>
</li>
<li><a>站长</a><ul><li><a target="_blank" href="https://laoguaige.github.io/">老怪鸽</a></li>
<li><a>邮箱: liguoyi@hdochub.cn</a>
</li>
</ul>
</li>
<li><a>源码</a><ul><li><a target="_blank" href="https://github.com/LaoGuaiGe/laoguaige.github.io">本站源文件</a></li>
</ul>
</li>
</ul>

            </div>
            <div id="footer_bottom">
                <ul>
<li><a target="_blank" href="https://laoguaige.github.io/">Copyright © 2024 Hdochub</a></li>
</ul>

            </div>
        </div>
    </div>
    
        <script src="/teedoc-plugin-markdown-parser/mermaid.min.js"></script>
    
        <script>mermaid.initialize({startOnLoad:true});</script>
    
        <script src="/static/js/theme_default/tocbot.min.js"></script>
    
        <script src="/static/js/theme_default/main.js"></script>
    
        <script src="/static/js/theme_default/viewer.min.js"></script>
    
        <script src="/static/css/theme_default/prism.min.js"></script>
    
        <link rel="stylesheet" href="/static/js/add_hint/style.css" type="text/css"/>
    
        <script src="/static/js/add_hint/main.js"></script>
    
        <script src="/static/js/gitalk/gitalk.min.js"></script>
    
        <script src="/static/js/gitalk/main.js"></script>
    
        <script src="/static/js/custom.js"></script>
    
        <script src="/static/js/search/search_main.js"></script>
    
</body>

</html>